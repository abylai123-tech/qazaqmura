<script lang="ts" setup>
import { computed, ref, type Ref, onUnmounted } from 'vue'
import { useAPI } from '@/api'
import HelpButton from '@/components/HelpButton.vue'
import { useAuth } from '@/auth'
import BkDialog from '@/components/bkDialog.vue'
import { useRouter, useRoute } from 'vue-router'
import { useI18n } from 'vue-i18n'
import { useToastStore } from '@/stores/toast'
import { useBookStore } from '@/stores/book'
const { t } = useI18n()
const api = useAPI()
const toast = useToastStore()
const route = useRoute()
const bookStore = useBookStore()

interface Form {
  author_id: number[]
  author_id_main: number[]
  bbk_id: number | null
  udk_id: number | null
  category_id: number | null
  annotation: string
  genre_id: number[] | null
  ISBN: string
  language_id: number[] | null
  pages: number | null
  publisher_id: number | null
  quotes: string
  title: string
  title2: string
  city_id: number
  type_id: number | null
  year: number | null
  book_classroom: number | null
  book_classroom_language_id: number | null
  country_id: number | null
  amount: number | null
  copyright_sign_id: number | null
  content_type_id: number | null
  age_characteristic_id: number | null
  binding_id: number | null
  education_level_id: number | null
  reprint_book_id: number[] | null
  reprint_publisher_id: number[] | null
  titles: { language_id: number; title: string }[]
  tags: number[] | null
  part: number | null
  volume: number | null
  materials: number[]
  link: { URL: string; title: string }
  subject_heading_id: number | null
  discipline_id: number | null
  qualification_id: number | null
  profession_id: number | null
  specialty_id: number | null
  distribution: string
  copyright_holder: string
  creator_name: string
  creation_date: string
  marker_id: string
  type_description_id: string
  book_specials?: {
    sizes?: string
    material_info?: string
    additional_info?: string
  }
  book_areas?: {
    heading_id?: number
    additional_heading_id?: number
    additional_info?: string
    responsibility_info?: string
    first_info?: string
    next_info?: string
    ISSN?: string
    number?: string
  }
  book_addresses?: {
    country_id?: number
    city_id?: number
    postal_index?: string
    number?: string
    company_name?: string
    street_name?: string
  }
}

const hasClass = ref(false)

interface BookAdmission {
  amount: number
  book_id: number
  book_state_id: number | null
  price: number
  admission_at: string
  contractor_id: number | null
  book_admission_id: number | null
}

interface Author {
  id: number
  name: string
}

interface Publisher {
  id: number
  title: string
}

interface Material {
  id: number
  label: string
}

interface Contractor {
  address: string
  company_ID: string
  id: number
  system: boolean
  title: string
}

const valid: Ref<boolean> = ref(false)
const showAdditionalData: Ref<boolean> = ref(true)
const showFundData: Ref<boolean> = ref(true)
const authors: Ref<Author[]> = ref([])
const publishers: Ref<Publisher[]> = ref([])
const cities: Ref<Publisher[]> = ref([])
const types: Ref<Publisher[]> = ref([])
const languages: Ref<Publisher[]> = ref([])
const additionalAuthors: Ref<boolean> = ref(false)
const contractors: Ref<Contractor[]> = ref([])
const qualifications: Ref<any[]> = ref([])
const specialties: Ref<any[]> = ref([])
const professions: Ref<any[]> = ref([])
const disciplines: Ref<any[]> = ref([])
const states: Ref<Publisher[]> = ref([])
const admissions: Ref<Publisher[]> = ref([])
const materials: Ref<Material[]> = ref([])
const subjectHeading: Ref<Author[]> = ref([])
const ageCharacteristics: Ref<Author[]> = ref([])
const bindings: Ref<Publisher[]> = ref([])
const genres: Ref<Publisher[]> = ref([])
const contentTypes: Ref<Publisher[]> = ref([])
const parts = [
  {
    id: 1,
    title: 'Часть'
  },
  {
    id: 1,
    title: 'Том'
  }
]
const auth = useAuth()
const form: Ref<Form> = ref({
  author_id: [],
  author_id_main: [],
  bbk_id: null,
  udk_id: null,
  category_id: null,
  annotation: '',
  genre_id: [],
  city_id: null,
  ISBN: '',
  language_id: [],
  pages: null,
  publisher_id: null,
  quotes: '',
  title: '',
  title2: '',
  type_id: null,
  year: null,
  book_classroom: null,
  book_classroom_language_id: null,
  country_id: null,
  amount: null,
  copyright_sign_id: null,
  content_type_id: null,
  age_characteristic_id: null,
  binding_id: null,
  education_level_id: null,
  reprint_book_id: [],
  reprint_publisher_id: [],
  titles: [],
  tags: [],
  part: null,
  volume: null,
  materials: [],
  link: { URL: '', title: '' },
  subject_heading_id: null,
  distribution: '',
  copyright_holder: '',
  creator_name: '',
  creation_date: '',
  marker_id: '',
  type_description_id: '',
  book_specials: {},
  book_areas: {},
  book_addresses: {}
})
const admission: Ref<BookAdmission> = ref({
  amount: 0,
  book_id: 0,
  book_state_id: null,
  price: 0,
  admission_at: '',
  contractor_id: null,
  book_admission_id: null
})
const language: Ref<number> = ref(1)
const newItem: Ref<{
  name: string
  title: string
  active: boolean
  label: string
  itemType: 'author' | 'publisher' | 'genre' | 'subjectHeading' | 'contractor' | null
  companyId?: string
  address?: string
}> = ref({
  name: '',
  active: false,
  title: '',
  label: '',
  itemType: null
})

const showAdditionalParams = ref(false)
const distribution = ref('')
const distributionTypes = ['Общественное достояние', 'Правообладатель']
const copyrightHolder = ref('')
const manufacturer = ref('')
const manufacturingDate = ref('')
const recordMarker = ref('')
const descriptionLevel = ref('')

const showManufacturerAddress = ref(false)
const showMaterialSpecs = ref(false)
const showSeriesArea = ref(false)

const manufacturerAddress = ref({
  country: null,
  city: null,
  postalCode: '',
  street: '',
  houseNumber: '',
  company: ''
})

const materialSpecs = ref({
  size: '',
  accompanyingMaterial: '',
  otherPhysicalDetails: ''
})

const seriesArea = ref({
  mainTitle: '',
  parallelTitle: '',
  titleInfo: '',
  issueNumber: '',
  responsibilityInfo: {
    first: '',
    subsequent: ''
  },
  issn: ''
})

const epubFileInfo = computed(() => {
  if (epubFile.value) {
    return {
      name: epubFile.value.name,
      size: (epubFile.value.size / (1024 * 1024)).toFixed(2) + ' MB'
    }
  }
  return null
})

const handleCountrySelect = async () => {
  await getCountries(null, true)
}

const handleCitySelect = async () => {
  await getCities(null, true)
}

async function getAuthors(search = null) {
  try {
    let request = `/v1/author`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) authors.value = response.data.data.items
  } catch (error: any) {
    toast.error('Ошибка при загрузке списка авторов')
    console.error('Error:', error.message)
  }
}

async function addNewItem(
  itemType: 'author' | 'publisher' | 'genre' | 'subjectHeading' | 'contractor' | 'tag',
  isActive: Ref<boolean>
) {
  const request = itemType === 'subjectHeading' ? 'subject/heading' : itemType
  const requestBody: {
    name?: string
    title?: string
    company_ID?: string
    address?: string
    label?: string
  } = {}
  if (itemType === 'subjectHeading' || itemType === 'author') {
    requestBody.name = newItem.value.name
  } else if (itemType === 'contractor') {
    requestBody.title = newItem.value.name
    requestBody.company_ID = newItem.value.companyId
    requestBody.address = newItem.value.address
  } else if (itemType === 'tag') {
    requestBody.label = newItem.value.name
  } else {
    requestBody.title = newItem.value.name
  }
  try {
    const response = await api.postData(`/v1/${request}`, requestBody)
    if (itemType === 'author') {
      await getAuthors()
      toast.success('Автор успешно добавлен')
    } else if (itemType === 'publisher') {
      await getPublishers()
      toast.success('Издатель успешно добавлен')
    } else if (itemType === 'contractor') {
      await getContractors()
      toast.success('Контрагент успешно добавлен')
    } else if (itemType === 'tag') {
      await getTags()
      toast.success('Ключевое слово успешно добавлено')
    } else if (itemType === 'genre') {
      await getGenres()
      toast.success('Жанр успешно добавлен')
    } else if (itemType === 'subjectHeading') {
      await getSubjectHeadings()
      toast.success('Предметная рубрика успешно добавлена')
    }
    isActive.value = false
  } catch (error: any) {
    let errorMessage = 'Произошла ошибка при добавлении. Попробуйте еще раз'

    if (error.response?.data?.message) {
      errorMessage = error.response.data.message
    } else if (error.response?.data?.errors) {
      const errors = error.response.data.errors
      const firstError = Object.values(errors)[0]
      if (Array.isArray(firstError) && firstError.length > 0) {
        errorMessage = firstError[0]
      }
    }

    toast.error(errorMessage)
    console.error('Error:', error.message)
  }
}

async function getPublishers(search = null) {
  try {
    let request = `/v1/publisher`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) publishers.value = response.data.data.items
  } catch (error: any) {
    toast.error('Ошибка при загрузке списка издателей')
    console.error('Error:', error.message)
  }
}

async function getCities(search = null, forceRefresh = false) {
  try {
    let request = `/v1/city`
    if (search || forceRefresh) {
      request += `?search=${search || ''}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) cities.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getTypes(search = null) {
  try {
    let request = `/v1/type`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) types.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getLanguages(search = null) {
  try {
    let request = `/v1/language`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) languages.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getContractors(search = null) {
  try {
    let request = `/v1/contractor`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Contractor[] } }>(request)
    if (response.data) contractors.value = response.data.data.items
  } catch (error: any) {
    toast.error('Ошибка при загрузке списка контрагентов')
    console.error('Error:', error.message)
  }
}

async function getProfessions(search = null) {
  try {
    let request = `/v1/profession`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Contractor[] } }>(request)
    if (response.data) professions.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getSpecialties(search = null) {
  try {
    let request = `/v1/specialty`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Contractor[] } }>(request)
    if (response.data) specialties.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getDisciplines(search = null) {
  try {
    let request = '/v1/discipline'
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: any[] } }>(request)
    if (response.data) disciplines.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getQualifications(search = null) {
  try {
    let request = '/v1/qualification'
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: any[] } }>(request)
    if (response.data) qualifications.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getStates(search = null) {
  try {
    let request = `/v1/book/state`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) states.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getAdmissions(search = null) {
  try {
    let request = `/v1/book/admission`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) admissions.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getMaterials(search = null) {
  try {
    let request = `/v1/material`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Material[] } }>(request)
    if (response.data) materials.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

const admissionDate = ref('')

const handleDate = () => {
  let value = admissionDate.value.replace(/\D/g, '')
  if (value.length >= 3) {
    value = value.slice(0, 2) + '.' + value.slice(2)
  }
  if (value.length >= 6) {
    value = value.slice(0, 5) + '.' + value.slice(5)
  }
  if (value.length >= 10) {
    value = value.slice(0, 10)
  }
  admissionDate.value = value
}

async function getSubjectHeadings(search = null) {
  try {
    let request = `/v1/subject/heading`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) subjectHeading.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

const tags = ref([])

async function getTags(search = null) {
  try {
    let request = `/v1/tag`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) tags.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

const countries = ref([])

async function getCountries(search = null, forceRefresh = false) {
  try {
    let request = `/v1/country`
    if (search || forceRefresh) {
      request += `?search=${search || ''}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) countries.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

const copyrightSigns = ref([])

async function getCopyrightSigns(search = null) {
  try {
    let request = `/v1/copyright/sign`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) copyrightSigns.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getAgeCharacteristics(search = null) {
  try {
    let request = `/v1/age/characteristic`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Author[] } }>(request)
    if (response.data) ageCharacteristics.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

const bbk = ref(null)
const udk = ref(null)

const handleFinish = (value: any, mode: 'bbk' | 'udk') => {
  if (mode === 'bbk') {
    bbk.value = value
  } else {
    udk.value = value
  }
}

async function getBindings(search = null) {
  try {
    let request = `/v1/binding`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) bindings.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getGenres(search = null) {
  try {
    let request = `/v1/genre`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) genres.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

async function getContentTypes(search = null) {
  try {
    let request = `/v1/content/type`
    if (search) {
      request += `?search=${search}`
    }
    const response = await api.fetchData<{ data: { items: Publisher[] } }>(request)
    if (response.data) contentTypes.value = response.data.data.items
  } catch (error: any) {
    console.error('Error:', error.message)
  }
}

function removeNullOrEmptyFields(obj: any): any {
  const newObj: any = {}
  for (const key in obj) {
    const value = obj[key]
    if (
      value !== null &&
      value !== undefined &&
      !(Array.isArray(value) && value.length === 0) &&
      !(typeof value === 'string' && value.trim() === '')
    ) {
      newObj[key] = value
    }
  }
  return newObj
}

function setNewItem(
  itemType: 'author' | 'publisher' | 'genre' | 'subjectHeading' | 'contractor' | 'tag'
) {
  if (itemType === 'author') {
    newItem.value.title = 'Добавление автора'
    newItem.value.label = 'Имя автора'
  } else if (itemType === 'publisher') {
    newItem.value.title = 'Добавление издателя'
    newItem.value.label = 'Название издателя'
  } else if (itemType === 'genre') {
    newItem.value.title = 'Добавление жанра'
    newItem.value.label = 'Название жанра'
  } else if (itemType === 'subjectHeading') {
    newItem.value.title = 'Добавление предметной рубрики'
    newItem.value.label = 'Название предметной рубрики'
  } else if (itemType === 'contractor') {
    newItem.value.title = 'Добавление контрагента'
    newItem.value.label = 'Название контрагента'
  } else if (itemType === 'tag') {
    newItem.value.title = 'Добавление ключевого слова'
    newItem.value.label = 'Ключевое слово'
  }

  newItem.value.name = ''
  newItem.value.itemType = itemType
  newItem.value.active = true
}

const router = useRouter()

async function sendBookData() {
  const body = removeNullOrEmptyFields(form.value)

  if (body.materials) {
    body.materials = Array.isArray(body.materials) ? body.materials : [body.materials]
  }

  if (bbk.value) {
    body.bbk_id = bbk.value[bbk.value.length - 1].id
  }
  if (udk.value) {
    body.udk_id = udk.value[udk.value.length - 1].id
  }

  try {
    const response = await api.postData<Form, { id: number }>('/v1/book', body)
    const id = response.data.id
    if (response.data && showFundData.value) {
      admission.value.book_id = id
      await api.postData('/v1/book/admission', admission.value)
    }
    toast.success('Запись успешно добавлена')
    router.push('/m-data')
  } catch (error: any) {
    let errorMessage = error?.message || 'Ошибка при добавлении книги в фонд'
    toast.error(errorMessage)
    console.error('Error:', error)
  }
}

const cover = ref<HTMLInputElement | null>(null)
const epub = ref<HTMLInputElement | null>(null)
const file = ref<File | null>(null)
const epubFile = ref<File | null>(null)

const handleUpload = () => {
  cover.value?.click()
}

const handleEpub = () => {
  epub.value?.click()
}

const handleEpubUpload = (event) => {
  epubFile.value = event.target.files[0]
}

const handleFile = (event) => {
  file.value = event.target.files[0]
}

const coverPreview = computed(() => {
  if (file.value) {
    return URL.createObjectURL(file.value)
  }
  return null
})

function initializeFromStore() {
  if (bookStore.bookData) {
    form.value = {
      ...form.value,
      ...bookStore.bookData
    }
  }
}

getAuthors()
getPublishers()
getCities()
getTypes()
getLanguages()
getContractors()
getDisciplines()
getQualifications()
getStates()
getAdmissions()
getMaterials()
getSubjectHeadings()
getTags()
getCountries()
getCopyrightSigns()
getAgeCharacteristics()
getGenres()
getBindings()
getContentTypes()
initializeFromStore()

onUnmounted(() => {
  bookStore.clearBookData()
})
</script>

<template>
  <v-container fluid>
    <v-app-bar>
      <template v-slot:title>
        <div class="d-flex flex-column">
          <span class="text-h6 font-weight-bold">M-DATA</span>
          <span class="text-subtitle-2 text-medium-emphasis">{{ t('database_by_rk') }}</span>
        </div>
      </template>

      <template v-slot:append>
        <help-button video-id="8vUsW7Fs5M8 " class="mr-3" />
        <v-btn color="primary" prepend-icon="mdi-plus" to="/m-data/add" variant="flat"
          >{{ t('add') }}
        </v-btn>
      </template>
    </v-app-bar>

    <v-row>
      <v-col>
        <v-btn prepend-icon="mdi-arrow-left" to="/m-data" variant="text">Назад</v-btn>
      </v-col>
    </v-row>

    <v-row class="mt-6">
      <v-col cols="8" offset="2">
        <v-card>
          <v-card-title> Основные данные</v-card-title>

          <v-card-subtitle> 1/2</v-card-subtitle>

          <v-card-text>
            <v-form v-model="valid">
              <v-container fluid>
                <v-row>
                  <v-col>
                    <v-text-field
                      v-model="form.title"
                      :label="t('name')"
                      placeholder="Напишите название"
                      required
                      variant="outlined"
                    ></v-text-field>
                  </v-col>
                </v-row>

                <v-row>
                  <v-col>
                    <v-text-field
                      v-model="form.title2"
                      label="Доп заголовок"
                      placeholder="Напишите название"
                      variant="outlined"
                    ></v-text-field>
                  </v-col>
                </v-row>

                <v-row v-for="item in form.titles" :key="item.title">
                  <v-col cols="8">
                    <v-text-field
                      v-model="item.title"
                      label="Другое название"
                      placeholder="Напишите название"
                      variant="outlined"
                    ></v-text-field>
                  </v-col>
                  <v-col cols="4">
                    <v-select
                      v-model="item.language_id"
                      :items="languages"
                      item-value="id"
                      :label="t('language')"
                      variant="outlined"
                    ></v-select>
                  </v-col>
                  <v-col cols="12">
                    <v-text-field
                      v-model="item.title2"
                      label="Доп заголовок"
                      variant="outlined"
                    ></v-text-field>
                  </v-col>
                </v-row>

                <v-row>
                  <v-col>
                    <v-btn
                      color="primary"
                      prepend-icon="mdi-plus"
                      variant="outlined"
                      @click="form.titles.push({ title: '', language_id: language++ })"
                      >Другое название
                    </v-btn>
                  </v-col>
                </v-row>

                <v-row>
                  <v-col>
                    <v-textarea
                      v-model="form.annotation"
                      label="Аннотация"
                      placeholder="Напишите более 15 слов"
                      variant="outlined"
                    ></v-textarea>
                  </v-col>
                </v-row>

                <v-row>
                  <v-col>
                    <v-text-field
                      v-model="form.pages"
                      label="Страницы"
                      placeholder="Укажите"
                      type="number"
                      variant="outlined"
                    ></v-text-field>
                  </v-col>

                  <v-col>
                    <v-text-field
                      v-model="form.year"
                      :label="t('year_of_publication')"
                      placeholder="Укажите"
                      prepend-inner-icon="mdi-magnify"
                      type="number"
                      variant="outlined"
                    ></v-text-field>
                  </v-col>
                </v-row>
              </v-container>
            </v-form>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <v-row>
      <v-col cols="8" offset="2">
        <v-card>
          <v-card-title> Основные данные</v-card-title>

          <v-card-subtitle> 2/2</v-card-subtitle>

          <v-card-text>
            <v-container fluid>
              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.author_id_main"
                    :items="authors"
                    item-title="name"
                    item-value="id"
                    label="Основной автор"
                    placeholder="Укажите автора"
                    variant="outlined"
                    @update:search="getAuthors"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного автора нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('author')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row v-if="additionalAuthors">
                <v-col>
                  <v-autocomplete
                    v-model="form.author_id"
                    :items="authors"
                    item-title="name"
                    item-value="id"
                    label="Другие авторы"
                    multiple
                    placeholder="Укажите автора"
                    variant="outlined"
                    @update:search="getAuthors"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного автора нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('author')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row v-if="!additionalAuthors">
                <v-col>
                  <v-btn
                    color="primary"
                    prepend-icon="mdi-plus"
                    variant="outlined"
                    @click="additionalAuthors = true"
                  >
                    Добавить других авторов
                  </v-btn>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.qualification_id"
                    :items="qualifications"
                    item-title="title"
                    item-value="id"
                    label="Квалификация"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                    @update:search="getQualifications"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.ISBN"
                    label="ISBN"
                    placeholder="Укажите ISBN"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col cols="3">
                  <strong> Раздел произведения: </strong>
                </v-col>
                <v-col>
                  <v-select
                    v-model="form.part"
                    :items="parts"
                    item-value="id"
                    label="Произведение"
                    placeholder="Укажите произведение"
                    variant="outlined"
                  ></v-select>
                </v-col>
                <v-col>
                  <v-select
                    v-model="form.volume"
                    :items="[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]"
                    label="Цифра"
                    placeholder="Выберите цифру"
                    variant="outlined"
                  ></v-select>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-btn color="primary" prepend-icon="mdi-plus" variant="outlined">
                    ISBN дополнительный
                  </v-btn>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.publisher_id"
                    :items="publishers"
                    item-value="id"
                    :label="t('publisher')"
                    placeholder="Укажите издателя"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                    @update:search="getPublishers"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного издателя нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('publisher')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.city_id"
                    :items="cities"
                    item-value="id"
                    label="Город"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                    @update:search="getCities"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.amount"
                    label="Тираж"
                    placeholder="Поиск"
                    type="number"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.type_id"
                    :items="types"
                    item-value="id"
                    :label="t('type')"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.language_id"
                    :items="languages"
                    item-value="id"
                    :label="t('language')"
                    multiple
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.materials"
                    :items="materials"
                    chips
                    item-title="label"
                    item-value="id"
                    label="Обозначение материала"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
              </v-row>
            </v-container>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <v-row v-if="showAdditionalData">
      <v-col cols="8" offset="2">
        <v-card>
          <v-card-title>Дополнительные данные</v-card-title>

          <v-card-text>
            <v-container fluid>
              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.subject_heading_id"
                    :items="subjectHeading"
                    item-title="name"
                    item-value="id"
                    label="Предметная рубрика"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данной рубрики нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('subjectHeading')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    :items="tags"
                    chips
                    item-title="label"
                    item-value="id"
                    label="Ключевые слова"
                    multiple
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    return-object
                    variant="outlined"
                    @update:search="getTags"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного слова нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('tag')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <div class="d-flex">
                    <div class="d-flex flex-column w-50">
                      <span class="mb-2">ББК</span>
                      <bk-dialog mode="bbk" @finish="handleFinish($event, 'bbk')"></bk-dialog>
                      <div v-if="bbk" class="mt-2 font-weight-bold">
                        {{ bbk.map((item) => item.title).join(', ') }}
                      </div>
                    </div>
                    <div class="d-flex flex-column ml-4 w-50">
                      <span class="mb-2">УДК</span>
                      <bk-dialog mode="udk" @finish="handleFinish($event, 'udk')"></bk-dialog>
                      <div v-if="udk" class="mt-2 font-weight-bold">
                        {{ udk.map((item) => item.title).join(', ') }}
                      </div>
                    </div>
                  </div>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    :items="copyrightSigns"
                    label="Авторский знак"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    return-object
                    variant="outlined"
                    @update:search="getCopyrightSigns"
                  >
                    <template v-slot:selection="{ item }">
                      {{ item.raw.number }} - {{ item.raw.title }}
                    </template>
                    <template v-slot:item="{ props, item }">
                      <v-list-item :subtitle="item.raw.number" v-bind="props"
                        >{{ item.raw.number }} - {{ item.raw.title }}
                      </v-list-item>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.content_type_id"
                    :items="contentTypes"
                    item-value="id"
                    label="Виды содержания"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.age_characteristic_id"
                    :items="ageCharacteristics"
                    item-value="id"
                    label="Возрастная характеристика"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.binding_id"
                    :items="bindings"
                    item-value="id"
                    label="Переплет"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.genre_id"
                    :items="genres"
                    item-value="id"
                    label="Жанры"
                    multiple
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного жанра нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('genre')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-switch
                    v-model="hasClass"
                    color="primary"
                    label="Укажите для какого класса , если это учебник"
                  ></v-switch>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-select
                    :disabled="!hasClass"
                    :items="[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]"
                    label="Класс"
                    placeholder="Укажите класс"
                    prepend-inner-icon="mdi-magnify"
                    variant="outlined"
                  ></v-select>
                </v-col>
                <v-col>
                  <v-autocomplete
                    :items="countries"
                    item-title="title"
                    label="Страна"
                    placeholder="Поиск"
                    prepend-inner-icon="mdi-magnify"
                    return-object
                    variant="outlined"
                    @update:search="getCountries"
                    @update:model-value="handleCountrySelect"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <div class="d-flex justify-space-between">
                    <div class="d-flex flex-column">
                      <span class="mb-2">Обложка</span>
                      <v-img v-if="coverPreview" :src="coverPreview"></v-img>
                      <v-btn color="primary" variant="outlined" @click="handleUpload"
                        >Выбрать файл
                      </v-btn>
                      <input
                        ref="cover"
                        accept="image/png, image/jpg, image/jpeg"
                        style="display: none"
                        type="file"
                        @input="handleFile"
                      />
                      <small>до 5 MB в соотношении 70×100, формата png, jpg, jpeg</small>
                    </div>
                    <div class="d-flex flex-column ml-4">
                      <span class="mb-2">EPUB</span>
                      <v-btn color="primary" variant="outlined" @click="handleEpub">
                        Выбрать файл
                      </v-btn>
                      <input
                        ref="epub"
                        accept=".epub"
                        style="display: none"
                        type="file"
                        @input="handleEpubUpload"
                      />
                      <div v-if="epubFileInfo" class="mt-2">
                        <div class="text-body-2">{{ epubFileInfo.name }}</div>
                        <div class="text-caption">{{ epubFileInfo.size }}</div>
                      </div>
                    </div>
                  </div>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.discipline_id"
                    :items="disciplines"
                    item-value="id"
                    variant="outlined"
                    label="Дисциплина"
                    @update:search="getDisciplines"
                  />
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="form.profession_id"
                    :items="professions"
                    item-value="id"
                    variant="outlined"
                    label="Профессия"
                    @update:search="getProfessions"
                  />
                </v-col>
                <v-col>
                  <v-autocomplete
                    v-model="form.specialty_id"
                    :items="specialties"
                    item-value="id"
                    variant="outlined"
                    label="Специальность"
                    @update:search="getSpecialties"
                  />
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.link.title"
                    label="Ссылка"
                    :placeholder="t('name')"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
                <v-col>
                  <v-text-field
                    v-model="form.link.URL"
                    label="URL"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-select
                    v-model="form.distribution"
                    :items="distributionTypes"
                    label="Распространение"
                    variant="outlined"
                  ></v-select>
                </v-col>
              </v-row>

              <v-row v-if="form.distribution === 'Правообладатель'">
                <v-col>
                  <v-text-field
                    v-model="form.copyright_holder"
                    label="Правообладатель"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.creator_name"
                    label="Название изготовителя"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.creation_date"
                    label="Дата изготовления"
                    type="date"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.marker_id"
                    label="Маркер записи и поля данных"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="form.type_description_id"
                    label="Уровень описания"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-checkbox
                    v-model="showManufacturerAddress"
                    label="Адрес изготовления"
                  ></v-checkbox>

                  <v-expand-transition>
                    <div v-if="showManufacturerAddress">
                      <v-row>
                        <v-col>
                          <v-autocomplete
                            v-model="manufacturerAddress.country"
                            :items="countries"
                            item-title="title"
                            item-value="id"
                            label="Страна"
                            placeholder="Поиск"
                            variant="outlined"
                            @update:search="getCountries"
                            @update:model-value="handleCountrySelect"
                          ></v-autocomplete>
                        </v-col>
                        <v-col>
                          <v-autocomplete
                            v-model="manufacturerAddress.city"
                            :items="cities"
                            item-title="title"
                            item-value="id"
                            label="Город"
                            placeholder="Поиск"
                            variant="outlined"
                            @update:search="getCities"
                            @update:model-value="handleCitySelect"
                          ></v-autocomplete>
                        </v-col>
                      </v-row>
                      <v-row>
                        <v-col>
                          <v-text-field
                            v-model="manufacturerAddress.postalCode"
                            label="Почтовый индекс"
                            variant="outlined"
                          ></v-text-field>
                        </v-col>
                        <v-col>
                          <v-text-field
                            v-model="manufacturerAddress.street"
                            label="Улица"
                            variant="outlined"
                          ></v-text-field>
                        </v-col>
                      </v-row>
                      <v-row>
                        <v-col>
                          <v-text-field
                            v-model="manufacturerAddress.houseNumber"
                            label="Номер дома"
                            variant="outlined"
                          ></v-text-field>
                        </v-col>
                        <v-col>
                          <v-text-field
                            v-model="manufacturerAddress.company"
                            label="Компания"
                            variant="outlined"
                          ></v-text-field>
                        </v-col>
                      </v-row>
                    </div>
                  </v-expand-transition>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-checkbox
                    v-model="showMaterialSpecs"
                    label="Обозначение специфического вида материала и физические характеристики"
                  ></v-checkbox>

                  <v-expand-transition>
                    <div v-if="showMaterialSpecs">
                      <v-text-field
                        v-model="materialSpecs.size"
                        label="Размеры"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="materialSpecs.accompanyingMaterial"
                        label="Сведения о сопроводительном материале"
                        variant="outlined"
                      ></v-text-field>
                      <v-textarea
                        v-model="materialSpecs.otherPhysicalDetails"
                        label="Другие сведения о физической характеристике"
                        variant="outlined"
                      ></v-textarea>
                    </div>
                  </v-expand-transition>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-checkbox v-model="showSeriesArea" label="Область серии"></v-checkbox>

                  <v-expand-transition>
                    <div v-if="showSeriesArea">
                      <v-text-field
                        v-model="seriesArea.mainTitle"
                        label="Основное заглавие серии или подсерии"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.parallelTitle"
                        label="Параллельное заглавие серии или подсерии"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.titleInfo"
                        label="Сведения, относящиеся к заглавию серии или подсерии"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.issueNumber"
                        label="Номер выпуска серии или подсерии"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.responsibilityInfo.first"
                        label="Первые сведения"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.responsibilityInfo.subsequent"
                        label="Последующие сведения"
                        variant="outlined"
                      ></v-text-field>
                      <v-text-field
                        v-model="seriesArea.issn"
                        label="Международный стандартный номер сериального издания (ISSN)"
                        variant="outlined"
                      ></v-text-field>
                    </div>
                  </v-expand-transition>
                </v-col>
              </v-row>
            </v-container>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <v-row v-if="showFundData">
      <v-col cols="8" offset="2">
        <v-card>
          <v-card-title>Данные для фонда</v-card-title>

          <v-card-text>
            <v-container fluid>
              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="admission.book_admission_id"
                    :items="admissions"
                    item-value="id"
                    :label="t('reception')"
                    placeholder="Выберите"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
                <v-col>
                  <v-text-field
                    v-model="admissionDate"
                    label="Дата поступления"
                    type="text"
                    variant="outlined"
                    @input="handleDate"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="admission.contractor_id"
                    :items="contractors"
                    item-value="id"
                    :label="t('counterparty')"
                    placeholder="Укажите"
                    variant="outlined"
                    @update:search="getContractors"
                  >
                    <template v-slot:no-data>
                      <div class="px-4 d-flex justify-space-between align-center">
                        <span>Данного контрагента нет в списке</span>
                        <v-btn color="primary" variant="flat" @click="setNewItem('contractor')"
                          >{{ t('add') }}
                        </v-btn>
                      </div>
                    </template>
                  </v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-text-field
                    v-model="admission.amount"
                    :label="t('quantity')"
                    placeholder="Выберите"
                    type="number"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
                <v-col>
                  <v-text-field
                    v-model="admission.price"
                    :label="t('price')"
                    placeholder="0,00"
                    step="0.01"
                    type="number"
                    variant="outlined"
                  ></v-text-field>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-autocomplete
                    v-model="admission.book_state_id"
                    :items="states"
                    item-value="id"
                    :label="t('book_condition')"
                    placeholder="Выберите"
                    variant="outlined"
                  ></v-autocomplete>
                </v-col>
              </v-row>

              <v-row>
                <v-col>
                  <v-sheet class="px-2 py-2" color="#FFE4AF" rounded>
                    <span
                      >Обложка может быть незначительно повреждена, или потерта. На страницах могут
                      быть незначительные пометки или помарки. Страницы не порваны. Книга может быть
                      покороблена от воздействия влаги. Суперобложка может быть порвана или утеряна.
                      Переплет прочный.</span
                    >
                  </v-sheet>
                </v-col>
              </v-row>
            </v-container>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <v-row>
      <v-col class="text-center">
        <v-btn color="green" prepend-icon="mdi-plus" variant="flat" @click="sendBookData"
          >Добавить в фонд
        </v-btn>
      </v-col>
    </v-row>

    <v-dialog v-model="newItem.active" max-width="500">
      <template v-slot:default="{ isActive }">
        <v-card :title="newItem.title">
          <v-card-text>
            <v-form>
              <v-text-field
                v-model="newItem.name"
                :label="newItem.label"
                variant="outlined"
              ></v-text-field>
              <v-text-field
                v-if="newItem.itemType === 'contractor'"
                v-model="newItem.companyId"
                label="БИН"
                variant="outlined"
              ></v-text-field>
              <v-text-field
                v-if="newItem.itemType === 'contractor'"
                v-model="newItem.address"
                :label="t('address')"
                variant="outlined"
              ></v-text-field>
            </v-form>
          </v-card-text>

          <v-card-actions>
            <v-btn variant="outlined" @click="isActive.value = false">Отмена</v-btn>
            <v-spacer></v-spacer>
            <v-btn color="primary" variant="flat" @click="addNewItem(newItem.itemType, isActive)"
              >{{ t('add') }}
            </v-btn>
          </v-card-actions>
        </v-card>
      </template>
    </v-dialog>
  </v-container>
</template>
